<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Shotgun ObjC Api: /Users/rblau/Desktop/Projects/objc-api/master/Classes/Shotgun.m Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Icon.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Shotgun ObjC Api&#160;<span id="projectnumber">0.1b</span></div>
   <div id="projectbrief">Objective C API to talk to a Shotgun Instance</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">/Users/rblau/Desktop/Projects/objc-api/master/Classes/Shotgun.m</div>  </div>
</div>
<div class="contents">
<a href="_shotgun_8m.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//</span>
<a name="l00002"></a>00002 <span class="comment">//  Shotgun.m</span>
<a name="l00003"></a>00003 <span class="comment">//  ShotgunApi</span>
<a name="l00004"></a>00004 <span class="comment">//</span>
<a name="l00005"></a>00005 <span class="comment">//  Created by Rob Blau on 6/8/11.</span>
<a name="l00006"></a>00006 <span class="comment">//  Copyright 2011 Laika. All rights reserved.</span>
<a name="l00007"></a>00007 <span class="comment">//</span>
<a name="l00009"></a>00009 <span class="comment"></span>
<a name="l00010"></a>00010 <span class="preprocessor">#import &quot;SBJson.h&quot;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#import &quot;ASIHTTPRequest.h&quot;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#import &quot;ASIFormDataRequest.h&quot;</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="preprocessor">#import &quot;<a class="code" href="_shotgun_logging_8h.html" title="Macros to make logging easier.">ShotgunLogging.h</a>&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#import &quot;<a class="code" href="_shotgun_config_8h.html" title="A structure for storing information about how to interact with the server.">ShotgunConfig.h</a>&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#import &quot;<a class="code" href="_server_capabilities_8h.html" title="A structure for storing information about the server.">ServerCapabilities.h</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#import &quot;<a class="code" href="_client_capabilities_8h.html" title="A structure for storing information about the client.">ClientCapabilities.h</a>&quot;</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#import &quot;<a class="code" href="_shotgun_8h.html" title="The main import for the API. All public Shotgun functionality is defined.">Shotgun.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#import &quot;<a class="code" href="_shotgun_request_private_8h.html" title="Interface used by friend classes.">ShotgunRequestPrivate.h</a>&quot;</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="keyword">@interface </span><a class="code" href="interface_shotgun.html" title="Represents a connection to a shotgun server.">Shotgun</a>()
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="keyword">@property</span> (readwrite, nonatomic, retain) ShotgunConfig *config;
<a name="l00025"></a>00025 <span class="keyword">@property</span> (readwrite, nonatomic, retain) ServerCapabilities *serverCaps;
<a name="l00026"></a>00026 <span class="keyword">@property</span> (readwrite, nonatomic, retain) ClientCapabilities *clientCaps;
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)requestWithMethod_:(NSString *)method andParams:(<span class="keywordtype">id</span>)params;
<a name="l00029"></a>00029 - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)requestWithMethod_:(NSString *)method params:(<span class="keywordtype">id</span>)params includeScriptName:(BOOL)includeScriptName returnFirst:(BOOL)first;
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 - (id)decodeResponseHeaders_:(NSDictionary *)headers andBody:(NSString *)body;
<a name="l00032"></a>00032 - (void)responseErrors_:(<span class="keywordtype">id</span>)response;
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 - (id)transformInboundData_:(<span class="keywordtype">id</span>)data;
<a name="l00035"></a>00035 - (id)transformOutboundData_:(<span class="keywordtype">id</span>)data;
<a name="l00036"></a>00036 - (id)visitData_:(<span class="keywordtype">id</span>)data withVisitor:(<span class="keywordtype">id</span> (^)(<span class="keywordtype">id</span>))visitor;
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 - (NSDictionary *)buildPayloadWithConfig_:(ShotgunConfig *)config Method:(NSString *)method andParams:(NSDictionary *)params includeScriptName:(BOOL)includeScriptName;
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 - (NSString *)getSessionToken_;
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 - (NSArray *)parseRecords_:(<span class="keywordtype">id</span>)records;
<a name="l00043"></a>00043 - (NSString *)buildThumbUrlForEntity_:(<a class="code" href="interface_shotgun_entity.html" title="Represents a Shotgun entity.">ShotgunEntity</a> *)entity;
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 - (NSArray *)listFromObj_:(<span class="keywordtype">id</span>)obj;
<a name="l00046"></a>00046 - (NSArray *)listFromObj_:(<span class="keywordtype">id</span>)obj withKeyName:(NSString *)keyName andValueName:(NSString *)valueName;
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="keyword">@end</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="keyword">@implementation </span><a class="code" href="interface_shotgun.html" title="Represents a connection to a shotgun server.">Shotgun</a>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="keyword">@synthesize</span> config = config_;
<a name="l00053"></a>00053 <span class="keyword">@synthesize</span> clientCaps = clientCaps_;
<a name="l00054"></a>00054 <span class="keyword">@synthesize</span> serverCaps = serverCaps_;
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="preprocessor">#pragma mark - Initialize</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span>
<a name="l00058"></a><a class="code" href="interface_shotgun.html#a0df2794ff521d7ae23a3044bdb622c00">00058</a> + (id)shotgunWithUrl:(NSString *)url scriptName:(NSString *)scriptName andKey:(NSString *)key
<a name="l00059"></a>00059 {
<a name="l00060"></a>00060     <span class="keywordflow">return</span> [[[<a class="code" href="interface_shotgun.html" title="Represents a connection to a shotgun server.">Shotgun</a> alloc] initWithUrl:url scriptName:scriptName andKey:key] autorelease];
<a name="l00061"></a>00061 }
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="interface_shotgun.html#a97f41d4a0f20ed804b09bd4af3f1f01a">00063</a> - (id)initWithUrl:(NSString *)url scriptName:(NSString *)scriptName andKey:(NSString *)key
<a name="l00064"></a>00064 {
<a name="l00065"></a>00065     <span class="keyword">self</span> = [<span class="keyword">super</span> init];
<a name="l00066"></a>00066     <span class="keywordflow">if</span> (<span class="keyword">self</span>) {
<a name="l00067"></a>00067         ShotgunConfig *aConfig = [ShotgunConfig config];
<a name="l00068"></a>00068         aConfig.apiKey = key;
<a name="l00069"></a>00069         aConfig.scriptName = scriptName;
<a name="l00070"></a>00070         NSURL *parseUrl = [NSURL URLWithString:[url lowercaseString]];
<a name="l00071"></a>00071         aConfig.scheme = [parseUrl scheme];
<a name="l00072"></a>00072         <span class="keywordflow">if</span> (!([aConfig.scheme isEqualToString:<span class="stringliteral">@&quot;http&quot;</span>] || [aConfig.scheme isEqualToString:<span class="stringliteral">@&quot;https&quot;</span>]))
<a name="l00073"></a>00073             [NSException <span class="keyword">raise</span>:<span class="stringliteral">@&quot;Invalid url&quot;</span> format:<span class="stringliteral">@&quot;url must use http or https got &#39;%@&#39;&quot;</span>, url];
<a name="l00074"></a>00074         aConfig.server = [parseUrl host];
<a name="l00075"></a>00075         NSString *apiBase = [parseUrl path];
<a name="l00076"></a>00076         <span class="keywordflow">if</span> ([apiBase isEqualToString:<span class="stringliteral">@&quot;&quot;</span>])
<a name="l00077"></a>00077             aConfig.apiPath = [NSString stringWithFormat:@&quot;/%@/json&quot;, aConfig.apiVer];
<a name="l00078"></a>00078         <span class="keywordflow">else</span>
<a name="l00079"></a>00079             aConfig.apiPath = [NSString stringWithFormat:@&quot;%@/%@/json&quot;, apiBase, aConfig.apiVer];
<a name="l00080"></a>00080         <span class="keyword">self</span>.config = aConfig;
<a name="l00081"></a>00081         
<a name="l00082"></a>00082         <span class="comment">// Get and check server capabilities</span>
<a name="l00083"></a>00083         <a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *req = [<span class="keyword">self</span> <a class="code" href="interface_shotgun.html#adc4baaee5608612f4c2cf28f158296dc">info</a>];
<a name="l00084"></a>00084         [req <a class="code" href="interface_shotgun_request.html#ac522786022d1f48bb55502df523c2ee3">startSynchronous</a>];
<a name="l00085"></a>00085         NSDictionary *<a class="code" href="interface_shotgun.html#adc4baaee5608612f4c2cf28f158296dc">info</a> = [req <a class="code" href="interface_shotgun_request.html#a3dffc7ec86880fa40ac3890c2a92e0d6" title="The return value of the request.">response</a>];
<a name="l00086"></a>00086         <span class="keywordflow">if</span> (info)
<a name="l00087"></a>00087             <span class="keyword">self</span>.serverCaps = [ServerCapabilities serverCapabilitiesWithHost:self.config.server andMeta:info];
<a name="l00088"></a>00088         <span class="keywordflow">else</span>
<a name="l00089"></a>00089             <span class="keywordflow">return</span> Nil;
<a name="l00090"></a>00090         <span class="comment">// Get and check client capabilities</span>
<a name="l00091"></a>00091         <span class="keyword">self</span>.clientCaps = [ClientCapabilities clientCapabilities];
<a name="l00092"></a>00092     }
<a name="l00093"></a>00093     <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l00094"></a>00094 }
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="preprocessor">#pragma mark Query Information</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>
<a name="l00098"></a><a class="code" href="interface_shotgun.html#adc4baaee5608612f4c2cf28f158296dc">00098</a> - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)<a class="code" href="interface_shotgun.html#adc4baaee5608612f4c2cf28f158296dc">info</a> 
<a name="l00099"></a>00099 {
<a name="l00100"></a>00100     <span class="keywordflow">return</span> [<span class="keyword">self</span> requestWithMethod_:@&quot;info&quot; params:Nil includeScriptName:NO returnFirst:NO];
<a name="l00101"></a>00101 }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)findEntityOfType:(NSString *)entityType withFilters:(<span class="keywordtype">id</span>)filters
<a name="l00104"></a>00104 {
<a name="l00105"></a>00105     <span class="keywordflow">return</span> [<span class="keyword">self</span> findEntityOfType:entityType withFilters:filters andFields:Nil];
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)findEntityOfType:(NSString *)entityType withFilters:(<span class="keywordtype">id</span>)filters andFields:(<span class="keywordtype">id</span>)fields 
<a name="l00109"></a>00109 {
<a name="l00110"></a>00110     <span class="keywordflow">return</span> [<span class="keyword">self</span> findEntityOfType:entityType withFilters:filters andFields:fields andOrder:Nil andFilterOperator:Nil retiredOnly:NO];
<a name="l00111"></a>00111 }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)findEntityOfType:(NSString *)entityType withFilters:(<span class="keywordtype">id</span>)filters andFields:(<span class="keywordtype">id</span>)fields 
<a name="l00114"></a>00114                           andOrder:(<span class="keywordtype">id</span>)order andFilterOperator:(NSString *)filterOperator retiredOnly:(BOOL)retiredOnly
<a name="l00115"></a>00115 {
<a name="l00116"></a>00116     <a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *request = [<span class="keyword">self</span> findEntitiesOfType:entityType
<a name="l00117"></a>00117                                            withFilters:filters 
<a name="l00118"></a>00118                                              andFields:fields 
<a name="l00119"></a>00119                                               andOrder:order 
<a name="l00120"></a>00120                                      andFilterOperator:filterOperator
<a name="l00121"></a>00121                                               andLimit:1 
<a name="l00122"></a>00122                                                andPage:0 
<a name="l00123"></a>00123                                            retiredOnly:retiredOnly];
<a name="l00124"></a>00124     ShotgunPostProcessBlock oldPost = [request postProcessBlock];
<a name="l00125"></a>00125     [request setPostProcessBlock:^id (NSDictionary *headers, NSString *body) {
<a name="l00126"></a>00126         NSArray *results = oldPost(headers, body);
<a name="l00127"></a>00127         if ([results count] &gt; 0)
<a name="l00128"></a>00128             return [results objectAtIndex:0];
<a name="l00129"></a>00129         return Nil;        
<a name="l00130"></a>00130     }];
<a name="l00131"></a>00131     <span class="keywordflow">return</span> request;
<a name="l00132"></a>00132 }
<a name="l00133"></a>00133 
<a name="l00134"></a>00134 - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)findEntitiesOfType:(NSString *)entityType withFilters:(<span class="keywordtype">id</span>)filters
<a name="l00135"></a>00135 {
<a name="l00136"></a>00136     <span class="keywordflow">return</span> [<span class="keyword">self</span> findEntitiesOfType:entityType withFilters:filters andFields:Nil];
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)findEntitiesOfType:(NSString *)entityType withFilters:(<span class="keywordtype">id</span>)filters andFields:(<span class="keywordtype">id</span>)fields 
<a name="l00140"></a>00140 {
<a name="l00141"></a>00141     <span class="keywordflow">return</span> [<span class="keyword">self</span> findEntitiesOfType:entityType withFilters:filters andFields:fields 
<a name="l00142"></a>00142                            andOrder:Nil andFilterOperator:Nil andLimit:0 andPage:0 retiredOnly:NO];
<a name="l00143"></a>00143 }
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)findEntitiesOfType:(NSString *)entityType withFilters:(<span class="keywordtype">id</span>)filters andFields:(<span class="keywordtype">id</span>)fields 
<a name="l00146"></a>00146                        andOrder:(<span class="keywordtype">id</span>)order andFilterOperator:(NSString *)filterOperator
<a name="l00147"></a>00147 {
<a name="l00148"></a>00148     <span class="keywordflow">return</span> [<span class="keyword">self</span> findEntitiesOfType:entityType withFilters:filters andFields:fields 
<a name="l00149"></a>00149                            andOrder:order andFilterOperator:filterOperator andLimit:0 andPage:0 retiredOnly:NO];
<a name="l00150"></a>00150 }
<a name="l00151"></a>00151             
<a name="l00152"></a><a class="code" href="interface_shotgun.html#ac04b219d3330ec1142073b7404edea93">00152</a> - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)findEntitiesOfType:(NSString *)entityType withFilters:(<span class="keywordtype">id</span>)filters andFields:(<span class="keywordtype">id</span>)fields 
<a name="l00153"></a>00153                        andOrder:(<span class="keywordtype">id</span>)order andFilterOperator:(NSString *)filterOperator andLimit:(NSUInteger)limit
<a name="l00154"></a>00154                         andPage:(NSUInteger)page retiredOnly:(BOOL)retiredOnly
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156     <span class="comment">// Convert JSON args to objects</span>
<a name="l00157"></a>00157     <span class="keywordtype">id</span> checkedFilters = filters;
<a name="l00158"></a>00158     <span class="keywordflow">if</span> ([checkedFilters isKindOfClass:[NSString <span class="keyword">class</span>]])
<a name="l00159"></a>00159         checkedFilters = [filters JSONValue];
<a name="l00160"></a>00160     <span class="keywordtype">id</span> checkedFields = fields;
<a name="l00161"></a>00161     <span class="keywordflow">if</span> ([checkedFields isKindOfClass:[NSString <span class="keyword">class</span>]])
<a name="l00162"></a>00162         checkedFields = [fields JSONValue];
<a name="l00163"></a>00163     <span class="keywordtype">id</span> checkedOrder = order;
<a name="l00164"></a>00164     <span class="keywordflow">if</span> ([checkedOrder isKindOfClass:[NSString <span class="keyword">class</span>]])
<a name="l00165"></a>00165         checkedOrder = [order JSONValue];
<a name="l00166"></a>00166 
<a name="l00167"></a>00167     <span class="comment">// Convert simple array filter to a dictionary</span>
<a name="l00168"></a>00168     <span class="keywordflow">if</span> ([checkedFilters isKindOfClass:[NSArray <span class="keyword">class</span>]]) {
<a name="l00169"></a>00169         NSMutableDictionary *newFilters = [NSMutableDictionary dictionary];
<a name="l00170"></a>00170         <span class="keywordflow">if</span> ((filterOperator == Nil) || [filterOperator isEqualToString:@&quot;all&quot;])
<a name="l00171"></a>00171             [newFilters setObject:<span class="stringliteral">@&quot;and&quot;</span> forKey:<span class="stringliteral">@&quot;logical_operator&quot;</span>];
<a name="l00172"></a>00172         <span class="keywordflow">else</span>
<a name="l00173"></a>00173             [newFilters setObject:@&quot;or&quot; forKey:@&quot;logical_operator&quot;];
<a name="l00174"></a>00174         NSMutableArray *conditions = [NSMutableArray array];
<a name="l00175"></a>00175         <span class="keywordflow">for</span> (NSArray *filter in checkedFilters)
<a name="l00176"></a>00176             [conditions addObject:[NSDictionary dictionaryWithObjectsAndKeys:
<a name="l00177"></a>00177                                         [filter objectAtIndex:0], @&quot;path&quot;,
<a name="l00178"></a>00178                                         [filter objectAtIndex:1], @&quot;relation&quot;,
<a name="l00179"></a>00179                                         [filter subarrayWithRange:NSMakeRange(2, [filter count]-2)], @&quot;values&quot;,
<a name="l00180"></a>00180                                     nil]];
<a name="l00181"></a>00181         [newFilters setObject:conditions forKey:@&quot;conditions&quot;];
<a name="l00182"></a>00182         checkedFilters = newFilters;
<a name="l00183"></a>00183     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (filterOperator != Nil)
<a name="l00184"></a>00184         [NSException raise:@&quot;Shotgun Error&quot; format:@&quot;Use of filter_operator only valid when passing in an array filter.&quot;];
<a name="l00185"></a>00185     
<a name="l00186"></a>00186     <span class="comment">// Defaults for fields</span>
<a name="l00187"></a>00187     <span class="keywordflow">if</span> (checkedFields == Nil)
<a name="l00188"></a>00188         checkedFields = [NSArray arrayWithObjects:@&quot;id&quot;, nil];
<a name="l00189"></a>00189     
<a name="l00190"></a>00190     <span class="comment">// Type check variable typed arguments</span>
<a name="l00191"></a>00191     <span class="keywordflow">if</span> (![checkedFilters isKindOfClass:[NSDictionary <span class="keyword">class</span>]])
<a name="l00192"></a>00192         [NSException raise:@&quot;Value Error&quot; format:@&quot;Invalid filters: %@&quot;, filters];
<a name="l00193"></a>00193     <span class="keywordflow">if</span> (![checkedFields isKindOfClass:[NSArray <span class="keyword">class</span>]])
<a name="l00194"></a>00194         [NSException raise:@&quot;Value Error&quot; format:@&quot;Invalid fields: %@&quot;, fields];
<a name="l00195"></a>00195     <span class="keywordflow">if</span> ((checkedOrder != Nil) &amp;&amp; ![checkedOrder isKindOfClass:[NSArray class]])
<a name="l00196"></a>00196         [NSException <span class="keyword">raise</span>:<span class="stringliteral">@&quot;Value Error&quot;</span> format:<span class="stringliteral">@&quot;Invalid order: %@&quot;</span>, order];
<a name="l00197"></a>00197         
<a name="l00198"></a>00198     <span class="comment">// Inital parameters</span>
<a name="l00199"></a>00199     __block NSMutableDictionary *params = [NSMutableDictionary dictionaryWithObjectsAndKeys:
<a name="l00200"></a>00200                                         entityType, @&quot;type&quot;,
<a name="l00201"></a>00201                                         checkedFilters, @&quot;filters&quot;,
<a name="l00202"></a>00202                                         checkedFields, @&quot;return_fields&quot;,
<a name="l00203"></a>00203                                         retiredOnly ? @&quot;retired&quot; : @&quot;active&quot;, @&quot;return_only&quot;,
<a name="l00204"></a>00204                                         [NSMutableDictionary dictionaryWithObjectsAndKeys:
<a name="l00205"></a>00205                                                 [NSNumber numberWithUnsignedInteger:self.config.recordsPerPage], @&quot;entities_per_page&quot;,
<a name="l00206"></a>00206                                                 [NSNumber numberWithInt:1], @&quot;current_page&quot;,
<a name="l00207"></a>00207                                           nil], @&quot;paging&quot;,
<a name="l00208"></a>00208                                     nil];
<a name="l00209"></a>00209     
<a name="l00210"></a>00210     <span class="keywordflow">if</span> (<span class="keyword">self</span>.serverCaps.hasPaging)
<a name="l00211"></a>00211         [params setObject:[NSNumber numberWithBool:YES] forKey:@&quot;return_paging_info&quot;];
<a name="l00212"></a>00212 
<a name="l00213"></a>00213     <span class="comment">// Order</span>
<a name="l00214"></a>00214     <span class="keywordflow">if</span> (checkedOrder != Nil) {
<a name="l00215"></a>00215         NSMutableArray *sortList = [NSMutableArray array];
<a name="l00216"></a>00216         <span class="keywordflow">for</span> (NSDictionary *sort in checkedOrder) {
<a name="l00217"></a>00217             NSString *fieldName = [sort objectForKey:@&quot;column&quot;];
<a name="l00218"></a>00218             <span class="keywordflow">if</span> (fieldName == Nil)
<a name="l00219"></a>00219                 fieldName = [sort objectForKey:@&quot;field_name&quot;];
<a name="l00220"></a>00220             NSString *direction = [sort objectForKey:@&quot;direction&quot;];
<a name="l00221"></a>00221             <span class="keywordflow">if</span> (direction == Nil)
<a name="l00222"></a>00222                 direction = <span class="stringliteral">@&quot;asc&quot;</span>;
<a name="l00223"></a>00223             [sortList addObject:[NSDictionary dictionaryWithObjectsAndKeys:
<a name="l00224"></a>00224                                         fieldName, @&quot;field_name&quot;,
<a name="l00225"></a>00225                                         direction, @&quot;direction&quot;,
<a name="l00226"></a>00226                                   nil]];
<a name="l00227"></a>00227         }
<a name="l00228"></a>00228         [params setObject:sortList forKey:@&quot;sorts&quot;];
<a name="l00229"></a>00229     }
<a name="l00230"></a>00230     
<a name="l00231"></a>00231     <span class="keywordflow">if</span> (limit &amp;&amp; limit &lt;= <span class="keyword">self</span>.config.recordsPerPage) {
<a name="l00232"></a>00232         [[params objectForKey:@&quot;paging&quot;] 
<a name="l00233"></a>00233             setObject:[NSNumber numberWithUnsignedInteger:limit] forKey:@&quot;entities_per_page&quot;];
<a name="l00234"></a>00234         <span class="keywordflow">if</span> (page == 0)
<a name="l00235"></a>00235             page = 1;
<a name="l00236"></a>00236     }
<a name="l00237"></a>00237     
<a name="l00238"></a>00238     <span class="comment">// Paging return</span>
<a name="l00239"></a>00239     <span class="keywordflow">if</span> (page != 0) {
<a name="l00240"></a>00240         <span class="keywordflow">if</span> (<span class="keyword">self</span>.serverCaps.hasPaging)
<a name="l00241"></a>00241             [params setObject:[NSNumber numberWithBool:NO] forKey:@&quot;return_paging_info&quot;];
<a name="l00242"></a>00242         
<a name="l00243"></a>00243         [[params objectForKey:@&quot;paging&quot;] 
<a name="l00244"></a>00244                 setObject:[NSNumber numberWithUnsignedInteger:page] forKey:@&quot;current_page&quot;];
<a name="l00245"></a>00245         <a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *request = [<span class="keyword">self</span> requestWithMethod_:@&quot;read&quot; andParams:params];
<a name="l00246"></a>00246         ShotgunPostProcessBlock oldPost = [request postProcessBlock];
<a name="l00247"></a>00247         [request setPostProcessBlock:^id (NSDictionary *headers, NSString *body) {
<a name="l00248"></a>00248             NSArray *records = [oldPost(headers, body) objectForKey:@&quot;entities&quot;];
<a name="l00249"></a>00249             if (records == Nil)
<a name="l00250"></a>00250                 records = [NSArray array];
<a name="l00251"></a>00251             NSArray *ret = [<span class="keyword">self</span> parseRecords_:records];
<a name="l00252"></a>00252             return ret;
<a name="l00253"></a>00253         }];
<a name="l00254"></a>00254         <span class="keywordflow">return</span> request;
<a name="l00255"></a>00255     }
<a name="l00256"></a>00256     
<a name="l00257"></a>00257     <span class="comment">// Get as many pages as needed</span>
<a name="l00258"></a>00258     <a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *request = [<span class="keyword">self</span> requestWithMethod_:@&quot;read&quot; andParams:params];
<a name="l00259"></a>00259     ShotgunPostProcessBlock oldPost = [request postProcessBlock];
<a name="l00260"></a>00260     <span class="comment">// result[&#39;paging_info&#39;][&#39;entity_count&#39;] == len(records)</span>[request setPostProcessBlock:^id (NSDictionary *headers, NSString *body) {
<a name="l00261"></a>00261         NSDictionary *result = oldPost(headers, body);
<a name="l00262"></a>00262         NSArray *entities = [result objectForKey:@&quot;entities&quot;];
<a name="l00263"></a>00263         NSMutableArray *records = [NSMutableArray array];
<a name="l00264"></a>00264         NSArray *returnRecords = records;
<a name="l00265"></a>00265         while (entities) {
<a name="l00266"></a>00266             [records addObjectsFromArray:entities];
<a name="l00267"></a>00267             if (limit &amp;&amp; ([records count] &gt;= limit)) {
<a name="l00268"></a>00268                 returnRecords = [records subarrayWithRange:NSMakeRange(0, limit)];
<a name="l00269"></a>00269                 break;
<a name="l00270"></a>00270             }
<a name="l00271"></a>00271             
<a name="l00272"></a>00272             if ([[[result objectForKey:@&quot;paging_info&quot;] objectForKey:@&quot;entity_count&quot;] unsignedIntegerValue] == [records count])
<a name="l00273"></a>00273                 break;
<a name="l00274"></a>00274             NSNumber *currentPage = [[params objectForKey:@&quot;paging&quot;] objectForKey:@&quot;current_page&quot;];
<a name="l00275"></a>00275             NSNumber *nextPage = [NSNumber numberWithUnsignedInteger:[currentPage unsignedIntegerValue]+1];
<a name="l00276"></a>00276             [[params objectForKey:@&quot;paging&quot;] setObject:nextPage forKey:@&quot;current_page&quot;];
<a name="l00277"></a>00277             ShotgunRequest *nextPageRequest = [<span class="keyword">self</span> requestWithMethod_:@&quot;read&quot; andParams:params];
<a name="l00278"></a>00278             [nextPageRequest startSynchronous];
<a name="l00279"></a>00279             result = [nextPageRequest response];
<a name="l00280"></a>00280         }
<a name="l00281"></a>00281         NSArray *ret = [<span class="keyword">self</span> parseRecords_:returnRecords];
<a name="l00282"></a>00282         return ret;
<a name="l00283"></a>00283     }];
<a name="l00284"></a>00284     <span class="keywordflow">return</span> request;
<a name="l00285"></a>00285 }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287 <span class="preprocessor">#pragma mark Modify Information</span>
<a name="l00288"></a>00288 <span class="preprocessor"></span>
<a name="l00289"></a>00289 - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)createEntityOfType:(NSString *)entityType withData:(<span class="keywordtype">id</span>)data
<a name="l00290"></a>00290 {
<a name="l00291"></a>00291     <span class="keywordflow">return</span> [<span class="keyword">self</span> createEntityOfType:entityType withData:data returnFields:Nil];
<a name="l00292"></a>00292 }
<a name="l00293"></a>00293 
<a name="l00294"></a><a class="code" href="interface_shotgun.html#ae7bc9dc8d11018b28892a226f7d09aaf">00294</a> - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)createEntityOfType:(NSString *)entityType withData:(<span class="keywordtype">id</span>)data returnFields:(<span class="keywordtype">id</span>)returnFields
<a name="l00295"></a>00295 {
<a name="l00296"></a>00296     NSArray *argFields = returnFields;
<a name="l00297"></a>00297     <span class="keywordflow">if</span> (argFields == Nil)
<a name="l00298"></a>00298         argFields = [NSArray arrayWithObjects:@&quot;id&quot;, nil];
<a name="l00299"></a>00299     NSDictionary *params = [NSDictionary dictionaryWithObjectsAndKeys:
<a name="l00300"></a>00300                                 entityType, @&quot;type&quot;,
<a name="l00301"></a>00301                                 [<span class="keyword">self</span> listFromObj_:data], @&quot;fields&quot;,
<a name="l00302"></a>00302                                 argFields, @&quot;return_fields&quot;,
<a name="l00303"></a>00303                              nil];
<a name="l00304"></a>00304     <a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *request = [<span class="keyword">self</span> requestWithMethod_:@&quot;create&quot; params:params includeScriptName:YES returnFirst:YES];
<a name="l00305"></a>00305     ShotgunPostProcessBlock oldPost = [request postProcessBlock];
<a name="l00306"></a>00306     [request setPostProcessBlock:^id (NSDictionary *requests, NSString *body) {
<a name="l00307"></a>00307         id records = oldPost(requests, body);
<a name="l00308"></a>00308         NSArray *parsed = [<span class="keyword">self</span> parseRecords_:records];
<a name="l00309"></a>00309         NSDictionary *ret = [parsed objectAtIndex:0];
<a name="l00310"></a>00310         return ret;
<a name="l00311"></a>00311     }];
<a name="l00312"></a>00312     <span class="keywordflow">return</span> request;
<a name="l00313"></a>00313 }
<a name="l00314"></a>00314 
<a name="l00315"></a><a class="code" href="interface_shotgun.html#a447d1c9e3ffb9f413e0d82254487205b">00315</a> - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)updateEntityOfType:(NSString *)entityType withId:(NSNumber *)entityId withData:(<span class="keywordtype">id</span>)data
<a name="l00316"></a>00316 {
<a name="l00317"></a>00317     NSDictionary *params = [NSDictionary dictionaryWithObjectsAndKeys:
<a name="l00318"></a>00318                                 entityType, @&quot;type&quot;,
<a name="l00319"></a>00319                                 entityId, @&quot;id&quot;,
<a name="l00320"></a>00320                                 [<span class="keyword">self</span> listFromObj_:data], @&quot;fields&quot;,
<a name="l00321"></a>00321                              nil];
<a name="l00322"></a>00322     <a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *request = [<span class="keyword">self</span> requestWithMethod_:@&quot;update&quot; andParams:params];
<a name="l00323"></a>00323     ShotgunPostProcessBlock oldPost = [request postProcessBlock];
<a name="l00324"></a>00324     [request setPostProcessBlock:^id (NSDictionary *requests, NSString *body) {
<a name="l00325"></a>00325         id records = oldPost(requests, body);
<a name="l00326"></a>00326         NSArray *parsed = [<span class="keyword">self</span> parseRecords_:records];
<a name="l00327"></a>00327         NSDictionary *ret = [parsed objectAtIndex:0];
<a name="l00328"></a>00328         return ret;
<a name="l00329"></a>00329     }];
<a name="l00330"></a>00330     <span class="keywordflow">return</span> request;
<a name="l00331"></a>00331 }
<a name="l00332"></a>00332 
<a name="l00333"></a><a class="code" href="interface_shotgun.html#a565f9821e52c8d28eb14d1c4a6a0992e">00333</a> - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)deleteEntityOfType:(NSString *)entityType withId:(NSNumber *)entityId
<a name="l00334"></a>00334 {
<a name="l00335"></a>00335     NSDictionary *params = [NSDictionary dictionaryWithObjectsAndKeys:
<a name="l00336"></a>00336                                 entityType, @&quot;type&quot;,
<a name="l00337"></a>00337                                 entityId, @&quot;id&quot;,
<a name="l00338"></a>00338                              nil];
<a name="l00339"></a>00339     <a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *ret = [<span class="keyword">self</span> requestWithMethod_:@&quot;delete&quot; andParams:params];
<a name="l00340"></a>00340     <span class="keywordflow">return</span> ret;
<a name="l00341"></a>00341 }
<a name="l00342"></a>00342 
<a name="l00343"></a><a class="code" href="interface_shotgun.html#a54271ca5308c283021e85adca59b6723">00343</a> - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)reviveEntityOfType:(NSString *)entityType withId:(NSNumber *)entityId
<a name="l00344"></a>00344 {
<a name="l00345"></a>00345     NSDictionary *params = [NSDictionary dictionaryWithObjectsAndKeys:
<a name="l00346"></a>00346                                 entityType, @&quot;type&quot;,
<a name="l00347"></a>00347                                 entityId, @&quot;id&quot;,
<a name="l00348"></a>00348                              nil];
<a name="l00349"></a>00349     <a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *ret = [<span class="keyword">self</span> requestWithMethod_:@&quot;revive&quot; andParams:params];
<a name="l00350"></a>00350     <span class="keywordflow">return</span> ret;
<a name="l00351"></a>00351 }
<a name="l00352"></a>00352 
<a name="l00353"></a><a class="code" href="interface_shotgun.html#adfe83e4b3848c868cf8c28c71c656e71">00353</a> - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)batch:(<span class="keywordtype">id</span>)requests
<a name="l00354"></a>00354 {
<a name="l00355"></a>00355     <span class="comment">// Convert JSON arg to object</span>
<a name="l00356"></a>00356     <span class="keywordtype">id</span> checkedRequests = requests;
<a name="l00357"></a>00357     <span class="keywordflow">if</span> ([checkedRequests isKindOfClass:[NSString <span class="keyword">class</span>]])
<a name="l00358"></a>00358         checkedRequests = [requests JSONValue];
<a name="l00359"></a>00359     
<a name="l00360"></a>00360     NSMutableArray *calls = [NSMutableArray array];
<a name="l00361"></a>00361     <span class="keywordflow">for</span> (NSDictionary *request in checkedRequests) {
<a name="l00362"></a>00362         NSString *requestType = [request objectForKey:@&quot;request_type&quot;];
<a name="l00363"></a>00363         <span class="keywordflow">if</span> ([requestType isEqualToString:<span class="stringliteral">@&quot;create&quot;</span>]) {
<a name="l00364"></a>00364             NSSet *requiredKeys = [NSSet setWithObjects:@&quot;entity_type&quot;, @&quot;data&quot;, nil];
<a name="l00365"></a>00365             <span class="keywordflow">if</span> (![requiredKeys isSubsetOfSet:[NSSet setWithArray:[request allKeys]]])
<a name="l00366"></a>00366                 [NSException raise:@&quot;Shotgun Error&quot; format:@&quot;Batch create request missing a required key: %@ (was %@)&quot;, requiredKeys, request];
<a name="l00367"></a>00367             NSArray *returnFields = [request objectForKey:@&quot;return_fields&quot;];
<a name="l00368"></a>00368             <span class="keywordflow">if</span> (returnFields == Nil)
<a name="l00369"></a>00369                 returnFields = [NSArray arrayWithObjects:@&quot;id&quot;, nil];
<a name="l00370"></a>00370             [calls addObject:[NSDictionary dictionaryWithObjectsAndKeys:
<a name="l00371"></a>00371                                     @&quot;create&quot;, @&quot;request_type&quot;,
<a name="l00372"></a>00372                                     [request objectForKey:@&quot;entity_type&quot;], @&quot;type&quot;,
<a name="l00373"></a>00373                                     [<span class="keyword">self</span> listFromObj_:[request objectForKey:@&quot;data&quot;]], @&quot;fields&quot;,
<a name="l00374"></a>00374                                     returnFields, @&quot;return_fields&quot;,
<a name="l00375"></a>00375                                nil]];
<a name="l00376"></a>00376         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ([requestType isEqualToString:<span class="stringliteral">@&quot;update&quot;</span>]) {
<a name="l00377"></a>00377             NSSet *requiredKeys = [NSSet setWithObjects:@&quot;entity_type&quot;, @&quot;entity_id&quot;, @&quot;data&quot;, nil];
<a name="l00378"></a>00378             <span class="keywordflow">if</span> (![requiredKeys isSubsetOfSet:[NSSet setWithArray:[request allKeys]]])
<a name="l00379"></a>00379                 [NSException raise:@&quot;Shotgun Error&quot; format:@&quot;Batch update request missing a required key: %@ (was %@)&quot;, requiredKeys, request];
<a name="l00380"></a>00380             [calls addObject:[NSDictionary dictionaryWithObjectsAndKeys:
<a name="l00381"></a>00381                                     @&quot;update&quot;, @&quot;request_type&quot;,
<a name="l00382"></a>00382                                     [request objectForKey:@&quot;entity_type&quot;], @&quot;type&quot;,
<a name="l00383"></a>00383                                     [request objectForKey:@&quot;entity_id&quot;], @&quot;id&quot;,
<a name="l00384"></a>00384                                     [<span class="keyword">self</span> listFromObj_:[request objectForKey:@&quot;data&quot;]], @&quot;fields&quot;,
<a name="l00385"></a>00385                                nil]];
<a name="l00386"></a>00386         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ([requestType isEqualToString:<span class="stringliteral">@&quot;delete&quot;</span>]) {
<a name="l00387"></a>00387             NSSet *requiredKeys = [NSSet setWithObjects:@&quot;entity_type&quot;, @&quot;entity_id&quot;, nil];
<a name="l00388"></a>00388             <span class="keywordflow">if</span> (![requiredKeys isSubsetOfSet:[NSSet setWithArray:[request allKeys]]])
<a name="l00389"></a>00389                 [NSException raise:@&quot;Shotgun Error&quot; format:@&quot;Batch delete request missing a required key: %@ (was %@)&quot;, requiredKeys, request];
<a name="l00390"></a>00390             [calls addObject:[NSDictionary dictionaryWithObjectsAndKeys:
<a name="l00391"></a>00391                                     @&quot;delete&quot;, @&quot;request_type&quot;,
<a name="l00392"></a>00392                                     [request objectForKey:@&quot;entity_type&quot;], @&quot;type&quot;,
<a name="l00393"></a>00393                                     [request objectForKey:@&quot;entity_id&quot;], @&quot;id&quot;,
<a name="l00394"></a>00394                                nil]];
<a name="l00395"></a>00395         } <span class="keywordflow">else</span> {
<a name="l00396"></a>00396             [NSException raise:@&quot;Shotgun Error&quot; format:@&quot;Invalid requestType &#39;%@&#39; for batch&quot;, requestType];
<a name="l00397"></a>00397         }
<a name="l00398"></a>00398     }
<a name="l00399"></a>00399     <a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *request = [<span class="keyword">self</span> requestWithMethod_:@&quot;batch&quot; andParams:calls];
<a name="l00400"></a>00400     ShotgunPostProcessBlock oldPost = [request postProcessBlock];
<a name="l00401"></a>00401     [request setPostProcessBlock:^id (NSDictionary *requests, NSString *body) {
<a name="l00402"></a>00402         id records = oldPost(requests, body);
<a name="l00403"></a>00403         NSArray *parsed = [<span class="keyword">self</span> parseRecords_:records];
<a name="l00404"></a>00404         return parsed;
<a name="l00405"></a>00405     }];
<a name="l00406"></a>00406     <span class="keywordflow">return</span> request;
<a name="l00407"></a>00407 }
<a name="l00408"></a>00408 
<a name="l00409"></a>00409 <span class="preprocessor">#pragma mark Meta Schema</span>
<a name="l00410"></a>00410 <span class="preprocessor"></span>
<a name="l00411"></a><a class="code" href="interface_shotgun.html#ac0f71bb6a509ee2aa2a077c34a405ffd">00411</a> - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)<a class="code" href="interface_shotgun.html#ac0f71bb6a509ee2aa2a077c34a405ffd">schemaEntityRead</a>
<a name="l00412"></a>00412 {
<a name="l00413"></a>00413     <span class="keywordflow">return</span> [<span class="keyword">self</span> requestWithMethod_:@&quot;schema_entity_read&quot; andParams:Nil];
<a name="l00414"></a>00414 }
<a name="l00415"></a>00415 
<a name="l00416"></a><a class="code" href="interface_shotgun.html#a6351727ca79e7f669f712ad48ab96178">00416</a> - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)<a class="code" href="interface_shotgun.html#a6351727ca79e7f669f712ad48ab96178">schemaRead</a> 
<a name="l00417"></a>00417 {
<a name="l00418"></a>00418     <span class="keywordflow">return</span> [<span class="keyword">self</span> requestWithMethod_:@&quot;schema_read&quot; andParams:Nil];
<a name="l00419"></a>00419 }
<a name="l00420"></a>00420 
<a name="l00421"></a>00421 - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)schemaFieldReadForEntityOfType:(NSString *)entityType 
<a name="l00422"></a>00422 {
<a name="l00423"></a>00423     <span class="keywordflow">return</span> [<span class="keyword">self</span> schemaFieldReadForEntityOfType:entityType forField:Nil];
<a name="l00424"></a>00424 }
<a name="l00425"></a>00425 
<a name="l00426"></a><a class="code" href="interface_shotgun.html#a714f6f4bf515124d089c03aad10ecc53">00426</a> - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)schemaFieldReadForEntityOfType:(NSString *)entityType forField:(NSString *)fieldName 
<a name="l00427"></a>00427 {
<a name="l00428"></a>00428     NSMutableDictionary *params = [NSMutableDictionary dictionaryWithObjectsAndKeys:entityType, @&quot;type&quot;, nil];
<a name="l00429"></a>00429     <span class="keywordflow">if</span> (fieldName != Nil)
<a name="l00430"></a>00430         [params setObject:fieldName forKey:@&quot;field_name&quot;];
<a name="l00431"></a>00431     <span class="keywordflow">return</span> [<span class="keyword">self</span> requestWithMethod_:@&quot;schema_field_read&quot; andParams:params];
<a name="l00432"></a>00432 }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434 - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)schemaFieldCreateForEntityOfType:(NSString *)entityType ofDataType:(NSString *)dataType 
<a name="l00435"></a>00435                                withDisplayName:(NSString *)displayName
<a name="l00436"></a>00436 {
<a name="l00437"></a>00437     <span class="keywordflow">return</span> [<span class="keyword">self</span> schemaFieldCreateForEntityOfType:entityType ofDataType:dataType withDisplayName:displayName andProperties:Nil];
<a name="l00438"></a>00438 }
<a name="l00439"></a>00439 
<a name="l00440"></a><a class="code" href="interface_shotgun.html#a13803321bb6f10e6d232d583ccf429d6">00440</a> - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)schemaFieldCreateForEntityOfType:(NSString *)entityType ofDataType:(NSString *)dataType
<a name="l00441"></a>00441                                withDisplayName:(NSString *)displayName andProperties:(<span class="keywordtype">id</span>)properties
<a name="l00442"></a>00442 {
<a name="l00443"></a>00443     NSMutableArray *propertiesParam = [NSMutableArray arrayWithObjects:
<a name="l00444"></a>00444                                             [NSDictionary dictionaryWithObjectsAndKeys:
<a name="l00445"></a>00445                                                     @&quot;name&quot;, @&quot;property_name&quot;,
<a name="l00446"></a>00446                                                     displayName, @&quot;value&quot;,
<a name="l00447"></a>00447                                               nil],
<a name="l00448"></a>00448                                         nil];
<a name="l00449"></a>00449     [propertiesParam addObjectsFromArray:[<span class="keyword">self</span> listFromObj_:properties
<a name="l00450"></a>00450                                                  withKeyName:@&quot;property_name&quot;
<a name="l00451"></a>00451                                                 andValueName:@&quot;value&quot;]];
<a name="l00452"></a>00452     NSDictionary *params = [NSDictionary dictionaryWithObjectsAndKeys:
<a name="l00453"></a>00453                                 entityType, @&quot;type&quot;,
<a name="l00454"></a>00454                                 dataType, @&quot;data_type&quot;,
<a name="l00455"></a>00455                                 propertiesParam, @&quot;properties&quot;,
<a name="l00456"></a>00456                              nil];
<a name="l00457"></a>00457     <span class="keywordflow">return</span> [<span class="keyword">self</span> requestWithMethod_:@&quot;schema_field_create&quot; andParams:params];
<a name="l00458"></a>00458 }
<a name="l00459"></a>00459 
<a name="l00460"></a>00460 - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)schemaFieldUpdateForEntityOfType:(NSString *)entityType forField:(NSString *)fieldName withProperties:(NSDictionary *)properties
<a name="l00461"></a>00461 {
<a name="l00462"></a>00462     NSDictionary *params = [NSDictionary dictionaryWithObjectsAndKeys:
<a name="l00463"></a>00463                                 entityType, @&quot;type&quot;,
<a name="l00464"></a>00464                                 fieldName, @&quot;field_name&quot;,
<a name="l00465"></a>00465                                 [<span class="keyword">self</span> listFromObj_:properties withKeyName:@&quot;property_name&quot; andValueName:@&quot;value&quot;], @&quot;properties&quot;,
<a name="l00466"></a>00466                             nil];
<a name="l00467"></a>00467     <span class="keywordflow">return</span> [<span class="keyword">self</span> requestWithMethod_:@&quot;schema_field_update&quot; andParams:params];
<a name="l00468"></a>00468 }
<a name="l00469"></a>00469 
<a name="l00470"></a><a class="code" href="interface_shotgun.html#a7640d48fe872603dd75f26a04c027d6f">00470</a> - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)schemaFieldDeleteForEntityOfType:(NSString *)entityType forField:(NSString *)fieldName 
<a name="l00471"></a>00471 {
<a name="l00472"></a>00472     NSDictionary *params = [NSDictionary dictionaryWithObjectsAndKeys:
<a name="l00473"></a>00473                                 entityType, @&quot;type&quot;,
<a name="l00474"></a>00474                                 fieldName, @&quot;field_name&quot;,
<a name="l00475"></a>00475                              nil];
<a name="l00476"></a>00476     <span class="keywordflow">return</span> [<span class="keyword">self</span> requestWithMethod_:@&quot;schema_field_delete&quot; andParams:params];
<a name="l00477"></a>00477 }
<a name="l00478"></a>00478 
<a name="l00479"></a><a class="code" href="interface_shotgun.html#ae0c771c7d23cd74b7be47073b08f3138">00479</a> - (void)setSessionUuid:(NSString *)uuid
<a name="l00480"></a>00480 {
<a name="l00481"></a>00481     <span class="keyword">self</span>.config.sessionUuid = uuid;
<a name="l00482"></a>00482 }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484 <span class="preprocessor">#pragma mark Upload and Download Files</span>
<a name="l00485"></a>00485 <span class="preprocessor"></span>
<a name="l00486"></a><a class="code" href="interface_shotgun.html#a657afa4139359ca8f8399cc5eb2ab917">00486</a> - (NSNumber *)uploadThumbnailForEntityOfType:(NSString *)entityType withId:(NSNumber *)entityId fromPath:(NSString *)path 
<a name="l00487"></a>00487 {
<a name="l00488"></a>00488     <span class="keywordflow">return</span> [<span class="keyword">self</span> <a class="code" href="interface_shotgun.html#ac3cd8bcc493d42c0ed1c73238523f650">uploadForEntityOfType</a>:entityType <a class="code" href="interface_shotgun.html#ac3cd8bcc493d42c0ed1c73238523f650">withId</a>:entityId <a class="code" href="interface_shotgun.html#ac3cd8bcc493d42c0ed1c73238523f650">fromPath</a>:path <a class="code" href="interface_shotgun.html#ac3cd8bcc493d42c0ed1c73238523f650">forField</a>:@&quot;thumb_image&quot; <a class="code" href="interface_shotgun.html#ac3cd8bcc493d42c0ed1c73238523f650">withDisplayName</a>:Nil <a class="code" href="interface_shotgun.html#ac3cd8bcc493d42c0ed1c73238523f650">andTagList</a>:Nil];
<a name="l00489"></a>00489 }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491 - (NSNumber *)uploadForEntityOfType:(NSString *)entityType withId:(NSNumber *)entityId fromPath:(NSString *)path 
<a name="l00492"></a>00492 {
<a name="l00493"></a>00493     <span class="keywordflow">return</span> [<span class="keyword">self</span> uploadForEntityOfType:entityType withId:entityId fromPath:path forField:Nil withDisplayName:Nil andTagList:Nil];    
<a name="l00494"></a>00494 }
<a name="l00495"></a>00495 
<a name="l00496"></a><a class="code" href="interface_shotgun.html#ac3cd8bcc493d42c0ed1c73238523f650">00496</a> - (NSNumber *)uploadForEntityOfType:(NSString *)entityType withId:(NSNumber *)entityId fromPath:(NSString *)path forField:(NSString *)fieldName
<a name="l00497"></a>00497                     withDisplayName:(NSString *)displayName andTagList:(NSString *)tagList
<a name="l00498"></a>00498 {
<a name="l00499"></a>00499     path = [path stringByExpandingTildeInPath];
<a name="l00500"></a>00500     <span class="keywordflow">if</span> (![[NSFileManager defaultManager] fileExistsAtPath:path])
<a name="l00501"></a>00501         [NSException raise:@&quot;Value Error&quot; format:@&quot;Path must be a valid file, got &#39;%@&#39;&quot;, path];
<a name="l00502"></a>00502     
<a name="l00503"></a>00503     BOOL isThumbnail = [fieldName isEqualToString:@&quot;thumb_image&quot;];
<a name="l00504"></a>00504 
<a name="l00505"></a>00505     NSURL *url;
<a name="l00506"></a>00506     ASIFormDataRequest *request;
<a name="l00507"></a>00507     <span class="keywordflow">if</span> (isThumbnail) {
<a name="l00508"></a>00508         url = [[[NSURL alloc] initWithScheme:self.config.scheme host:self.config.server path:@&quot;/upload/publish_thumbnail&quot;] autorelease];
<a name="l00509"></a>00509         request = [ASIFormDataRequest requestWithURL:url];
<a name="l00510"></a>00510         [request setFile:path forKey:@&quot;thumb_image&quot;];
<a name="l00511"></a>00511     } <span class="keywordflow">else</span> {
<a name="l00512"></a>00512         url = [[[NSURL alloc] initWithScheme:self.config.scheme host:self.config.server path:@&quot;/upload/upload_file&quot;] autorelease];
<a name="l00513"></a>00513         request = [ASIFormDataRequest requestWithURL:url];
<a name="l00514"></a>00514         <span class="keywordflow">if</span> (displayName == Nil)
<a name="l00515"></a>00515             displayName = [path lastPathComponent];
<a name="l00516"></a>00516         <span class="keywordflow">if</span> (fieldName != Nil)
<a name="l00517"></a>00517             [request setPostValue:fieldName forKey:@&quot;field_name&quot;];
<a name="l00518"></a>00518         [request setPostValue:displayName forKey:@&quot;display_name&quot;];
<a name="l00519"></a>00519         [request setPostValue:tagList forKey:@&quot;tag_list&quot;];
<a name="l00520"></a>00520         [request setFile:path forKey:@&quot;file&quot;];
<a name="l00521"></a>00521     }
<a name="l00522"></a>00522     
<a name="l00523"></a>00523     [request setPostValue:entityType forKey:@&quot;entity_type&quot;];
<a name="l00524"></a>00524     [request setPostValue:entityId forKey:@&quot;entity_id&quot;];
<a name="l00525"></a>00525     [request setPostValue:self.config.scriptName forKey:@&quot;script_name&quot;];
<a name="l00526"></a>00526     [request setPostValue:self.config.apiKey forKey:@&quot;script_key&quot;];
<a name="l00527"></a>00527     <span class="keywordflow">if</span> (<span class="keyword">self</span>.config.sessionUuid != Nil)
<a name="l00528"></a>00528         [request setPostValue:self.config.sessionUuid forKey:@&quot;session_uuid&quot;];
<a name="l00529"></a>00529 
<a name="l00530"></a>00530     [request setPostFormat:ASIMultipartFormDataPostFormat];
<a name="l00531"></a>00531     [request <a class="code" href="interface_shotgun_request.html#ac522786022d1f48bb55502df523c2ee3">startSynchronous</a>];
<a name="l00532"></a>00532     NSError *error = [request <a class="code" href="interface_shotgun_request.html#ae7ad63f6797c300ccafb0f4caaa554e2" title="The value of an error if it occurred.">error</a>];
<a name="l00533"></a>00533     <span class="keywordflow">if</span> (error) {
<a name="l00534"></a>00534         <span class="keywordflow">if</span> ([request responseStatusCode] == 500)
<a name="l00535"></a>00535             [NSException raise:@&quot;Shotgun Error&quot; format:@&quot;Server encountered an internal error. &quot; \
<a name="l00536"></a>00536                 &quot;\n%@\n(%@)\n%@&quot;, [request url], request , error];
<a name="l00537"></a>00537         <span class="keywordflow">else</span>
<a name="l00538"></a>00538             [NSException raise:@&quot;Shotgun Error&quot; format:@&quot;Unanticipated error occurred uploading &quot; \
<a name="l00539"></a>00539                 &quot;%@: %@&quot;, path, error];
<a name="l00540"></a>00540     }
<a name="l00541"></a>00541     NSString *response = [request responseString];
<a name="l00542"></a>00542     SG_INFO(<span class="stringliteral">@&quot;Upload Response: %@&quot;</span>, response);
<a name="l00543"></a>00543     <span class="keywordflow">if</span> ([response characterAtIndex:0] != <span class="charliteral">&#39;1&#39;</span>)
<a name="l00544"></a>00544         [NSException raise:@&quot;File upload error&quot; format:@&quot;Could not upload file successfully, &quot; \
<a name="l00545"></a>00545             &quot;but not sure why.\nPath: %@\nUrl: %@\nError: %@&quot;, path, url, response];
<a name="l00546"></a>00546 
<a name="l00547"></a>00547     NSArray *splitResponse = [response componentsSeparatedByString:@&quot;:&quot;];
<a name="l00548"></a>00548     <span class="keywordflow">if</span> ([splitResponse count] &lt;= 1)
<a name="l00549"></a>00549         <span class="keywordflow">return</span> [NSNumber numberWithInt:0];
<a name="l00550"></a>00550     NSNumberFormatter *formatter = [[[NSNumberFormatter alloc] init] autorelease];
<a name="l00551"></a>00551     NSArray *splitValue = [[splitResponse objectAtIndex:1] componentsSeparatedByString:@&quot;\n&quot;];
<a name="l00552"></a>00552     [formatter setNumberStyle:NSNumberFormatterDecimalStyle];
<a name="l00553"></a>00553     <span class="keywordflow">return</span> [formatter numberFromString:[splitValue objectAtIndex:0]];
<a name="l00554"></a>00554 }
<a name="l00555"></a>00555 
<a name="l00556"></a><a class="code" href="interface_shotgun.html#a1d0c0f755088039d4d09b37656f1802d">00556</a> - (NSData *)downloadAttachmentWithId:(NSNumber *)attachmentId
<a name="l00557"></a>00557 {
<a name="l00558"></a>00558     NSString *sessionId = [<span class="keyword">self</span> getSessionToken_];
<a name="l00559"></a>00559     
<a name="l00560"></a>00560     NSString *path = [NSString stringWithFormat:@&quot;/file_serve/%@&quot;, attachmentId];
<a name="l00561"></a>00561     NSURL *url = [[[NSURL alloc] initWithScheme:self.config.scheme host:self.config.server path:path] autorelease];
<a name="l00562"></a>00562     ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:url];
<a name="l00563"></a>00563     [request setUserAgent:@&quot;Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10.5; en-US; &quot; \
<a name="l00564"></a>00564         &quot;rv:1.9.0.7) Gecko/2009021906 Firefox/3.0.7&quot;];
<a name="l00565"></a>00565     NSDictionary *properties = [NSMutableDictionary dictionary];
<a name="l00566"></a>00566     [properties setValue:@&quot;0&quot; forKey:NSHTTPCookieVersion];
<a name="l00567"></a>00567     [properties setValue:@&quot;_session_id&quot; forKey:NSHTTPCookieName];
<a name="l00568"></a>00568     [properties setValue:sessionId forKey:NSHTTPCookieValue];
<a name="l00569"></a>00569     [properties setValue:self.config.server forKey:NSHTTPCookieDomain];
<a name="l00570"></a>00570     [properties setValue:@&quot;/&quot; forKey:NSHTTPCookiePath];
<a name="l00571"></a>00571     NSHTTPCookie *cookie = [NSHTTPCookie cookieWithProperties:properties];
<a name="l00572"></a>00572     [request setUseCookiePersistence:NO];
<a name="l00573"></a>00573     [request setRequestCookies:[NSMutableArray arrayWithObject:cookie]];
<a name="l00574"></a>00574     [request <a class="code" href="interface_shotgun_request.html#ac522786022d1f48bb55502df523c2ee3">startSynchronous</a>];
<a name="l00575"></a>00575     NSError *error = [request <a class="code" href="interface_shotgun_request.html#ae7ad63f6797c300ccafb0f4caaa554e2" title="The value of an error if it occurred.">error</a>];
<a name="l00576"></a>00576     <span class="keywordflow">if</span> (error)
<a name="l00577"></a>00577         [NSException raise:@&quot;Shotgun Error&quot; format:@&quot;Failed to open %@, with code: %@ and message %@&quot;,
<a name="l00578"></a>00578          url, [error code], [error description]];
<a name="l00579"></a>00579     NSData *ret = [request responseData];
<a name="l00580"></a>00580     <span class="keywordflow">return</span> ret;
<a name="l00581"></a>00581 }
<a name="l00582"></a>00582 
<a name="l00583"></a>00583 <span class="preprocessor">#pragma mark - Destruction</span>
<a name="l00584"></a>00584 <span class="preprocessor"></span>
<a name="l00585"></a>00585 - (void)dealloc 
<a name="l00586"></a>00586 {
<a name="l00587"></a>00587     <span class="keyword">self</span>.clientCaps = Nil;
<a name="l00588"></a>00588     <span class="keyword">self</span>.serverCaps = Nil;
<a name="l00589"></a>00589     <span class="keyword">self</span>.config = Nil;
<a name="l00590"></a>00590     [<span class="keyword">super</span> dealloc];
<a name="l00591"></a>00591 }
<a name="l00592"></a>00592 
<a name="l00593"></a>00593 <span class="preprocessor">#pragma mark - Private Category Methods</span>
<a name="l00594"></a>00594 <span class="preprocessor"></span>
<a name="l00595"></a>00595 - (id)decodeResponseHeaders_:(NSDictionary *)headers andBody:(NSString *)body
<a name="l00596"></a>00596 {
<a name="l00597"></a>00597     NSString *contentType = [headers objectForKey:@&quot;content-type&quot;];
<a name="l00598"></a>00598     <span class="keywordflow">if</span> (contentType == Nil)
<a name="l00599"></a>00599         contentType = <span class="stringliteral">@&quot;application/json&quot;</span>;
<a name="l00600"></a>00600     <span class="keywordflow">else</span>
<a name="l00601"></a>00601         contentType = [contentType lowercaseString];
<a name="l00602"></a>00602     <span class="keywordflow">if</span> ([contentType hasPrefix:<span class="stringliteral">@&quot;application/json&quot;</span>] || [contentType hasPrefix:<span class="stringliteral">@&quot;text/javascript&quot;</span>])
<a name="l00603"></a>00603         <span class="keywordflow">return</span> [body JSONValue];
<a name="l00604"></a>00604     <span class="keywordflow">return</span> body;
<a name="l00605"></a>00605 }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607 - (void)responseErrors_:(<span class="keywordtype">id</span>)response
<a name="l00608"></a>00608 {
<a name="l00609"></a>00609     <span class="keywordflow">if</span> ([response isKindOfClass:[NSDictionary <span class="keyword">class</span>]]) {
<a name="l00610"></a>00610         <span class="keywordtype">id</span> exception = [(NSDictionary *)response objectForKey:@&quot;exception&quot;];
<a name="l00611"></a>00611         <span class="keywordflow">if</span> (exception != Nil) {
<a name="l00612"></a>00612             NSString *msg = [(NSDictionary *)response objectForKey:@&quot;message&quot;];
<a name="l00613"></a>00613             <span class="keywordflow">if</span> (msg == Nil)
<a name="l00614"></a>00614                 msg = <span class="stringliteral">@&quot;Unknown Error&quot;</span>;
<a name="l00615"></a>00615             [NSException raise:@&quot;Response Error&quot; format:@&quot;%@&quot;, msg];
<a name="l00616"></a>00616         }
<a name="l00617"></a>00617     }
<a name="l00618"></a>00618 }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620 - (NSString *)getSessionToken_ {
<a name="l00621"></a>00621     <span class="keywordflow">if</span> (<span class="keyword">self</span>.config.sessionToken != Nil)
<a name="l00622"></a>00622         <span class="keywordflow">return</span> <span class="keyword">self</span>.config.sessionToken;
<a name="l00623"></a>00623     
<a name="l00624"></a>00624     <a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *request = [<span class="keyword">self</span> requestWithMethod_:@&quot;get_session_token&quot; andParams:Nil];
<a name="l00625"></a>00625     [request <a class="code" href="interface_shotgun_request.html#ac522786022d1f48bb55502df523c2ee3">startSynchronous</a>];
<a name="l00626"></a>00626     NSDictionary *results = [request <a class="code" href="interface_shotgun_request.html#a3dffc7ec86880fa40ac3890c2a92e0d6" title="The return value of the request.">response</a>];
<a name="l00627"></a>00627     NSString *sessionToken = [results objectForKey:@&quot;session_id&quot;];
<a name="l00628"></a>00628     <span class="keywordflow">if</span> (sessionToken == Nil)
<a name="l00629"></a>00629         [NSException raise:@&quot;Shotgun Error&quot; format:@&quot;Could not extract session_id from %@&quot;, results];
<a name="l00630"></a>00630     <span class="keyword">self</span>.config.sessionToken = sessionToken;
<a name="l00631"></a>00631     <span class="keywordflow">return</span> <span class="keyword">self</span>.config.sessionToken;
<a name="l00632"></a>00632 }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634 - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)requestWithMethod_:(NSString *)method andParams:(<span class="keywordtype">id</span>)params
<a name="l00635"></a>00635 {
<a name="l00636"></a>00636     <span class="keywordflow">return</span> [<span class="keyword">self</span> requestWithMethod_:method params:params includeScriptName:YES returnFirst:NO];
<a name="l00637"></a>00637 }
<a name="l00638"></a>00638 
<a name="l00639"></a>00639 - (<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *)requestWithMethod_:(NSString *)method params:(<span class="keywordtype">id</span>)params includeScriptName:(BOOL)includeScriptName returnFirst:(BOOL)first
<a name="l00640"></a>00640 {
<a name="l00641"></a>00641     NSDictionary *paramsTransformed = [<span class="keyword">self</span> transformOutboundData_:params];
<a name="l00642"></a>00642     NSDictionary *payload = [<span class="keyword">self</span> buildPayloadWithConfig_:self.config Method:method andParams:paramsTransformed includeScriptName:includeScriptName];
<a name="l00643"></a>00643     NSString *encodedPayload = [payload JSONRepresentation];
<a name="l00644"></a>00644     NSDictionary *headers = [NSDictionary dictionaryWithObject:@&quot;application/json; charset=utf-8&quot; forKey:@&quot;content-type&quot;];
<a name="l00645"></a>00645     
<a name="l00646"></a>00646     <a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *request = 
<a name="l00647"></a>00647         [<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> <a class="code" href="interface_shotgun_request.html#a3f57155d0223b7dbc2df085410418476">shotgunRequestWithConfig</a>:self.config 
<a name="l00648"></a>00648                                             <a class="code" href="interface_shotgun_request.html#a3f57155d0223b7dbc2df085410418476">path</a>:self.config.apiPath
<a name="l00649"></a>00649                                             <a class="code" href="interface_shotgun_request.html#a3f57155d0223b7dbc2df085410418476">body</a>:encodedPayload 
<a name="l00650"></a>00650                                          <a class="code" href="interface_shotgun_request.html#a3f57155d0223b7dbc2df085410418476">headers</a>:headers <a class="code" href="interface_shotgun_request.html#a3f57155d0223b7dbc2df085410418476">andHTTPMethod</a>:@&quot;POST&quot;];
<a name="l00651"></a>00651     <span class="comment">// Parse the results</span>[request setPostProcessBlock:^id (NSDictionary *headers, NSString *body) {
<a name="l00652"></a>00652         
<a name="l00653"></a>00653         id response = [<span class="keyword">self</span> decodeResponseHeaders_:headers andBody:body];
<a name="l00654"></a>00654         [<span class="keyword">self</span> responseErrors_:response];
<a name="l00655"></a>00655         id transformedResponse = [<span class="keyword">self</span> transformInboundData_:response];
<a name="l00656"></a>00656         if ([transformedResponse isKindOfClass:[NSDictionary class]]) {
<a name="l00657"></a>00657             id results = [(NSDictionary *)transformedResponse objectForKey:@&quot;results&quot;];
<a name="l00658"></a>00658             if (results == Nil)
<a name="l00659"></a>00659                 return transformedResponse;
<a name="l00660"></a>00660             if (first &amp;&amp; [results isKindOfClass:[NSArray class]])
<a name="l00661"></a>00661                 return [(NSArray *)results objectAtIndex:0];
<a name="l00662"></a>00662             return results;
<a name="l00663"></a>00663         }
<a name="l00664"></a>00664         return transformedResponse;
<a name="l00665"></a>00665     }];
<a name="l00666"></a>00666     <span class="keywordflow">return</span> request;
<a name="l00667"></a>00667 }
<a name="l00668"></a>00668 
<a name="l00669"></a>00669 - (NSArray *)parseRecords_:(<span class="keywordtype">id</span>)records 
<a name="l00670"></a>00670 {
<a name="l00671"></a>00671     NSMutableArray *ret = [NSMutableArray array];
<a name="l00672"></a>00672     <span class="keywordflow">if</span> (records == Nil)
<a name="l00673"></a>00673         <span class="keywordflow">return</span> ret;
<a name="l00674"></a>00674     NSArray *iteratee;
<a name="l00675"></a>00675     NSOperationQueue *queue = [[[NSOperationQueue alloc] init] autorelease];
<a name="l00676"></a>00676     [queue setMaxConcurrentOperationCount:4];
<a name="l00677"></a>00677     queue.name = <span class="stringliteral">@&quot;Thumbnail Converting Queue&quot;</span>;
<a name="l00678"></a>00678     <span class="keywordflow">if</span> (![records isKindOfClass:[NSArray <span class="keyword">class</span>]])
<a name="l00679"></a>00679         iteratee = [NSArray arrayWithObject:records];
<a name="l00680"></a>00680     <span class="keywordflow">else</span>
<a name="l00681"></a>00681         iteratee = records;
<a name="l00682"></a>00682     <span class="keywordflow">for</span> (<span class="keywordtype">id</span> record in iteratee) {
<a name="l00683"></a>00683         <span class="keywordflow">if</span> (![record isKindOfClass:[NSDictionary <span class="keyword">class</span>]]) {
<a name="l00684"></a>00684             [ret addObject:record];
<a name="l00685"></a>00685             <span class="keywordflow">continue</span>;
<a name="l00686"></a>00686         }
<a name="l00687"></a>00687         <a class="code" href="interface_shotgun_entity.html" title="Represents a Shotgun entity.">ShotgunEntity</a> *entity = [<a class="code" href="interface_shotgun_entity.html" title="Represents a Shotgun entity.">ShotgunEntity</a> <a class="code" href="interface_shotgun_entity.html#a99597a1ec71f8945471a44100ec85dde" title="Initialize an entity with the provided dictionary.">shotgunEntityWithDictionary</a>:record];
<a name="l00688"></a>00688         [ret addObject:entity];
<a name="l00689"></a>00689         <span class="keywordflow">for</span> (<span class="keywordtype">id</span> key in record) {
<a name="l00690"></a>00690             <span class="keywordtype">id</span> value = [entity objectForKey:key];
<a name="l00691"></a>00691             <span class="keywordflow">if</span> (value == Nil)
<a name="l00692"></a>00692                 <span class="keywordflow">continue</span>;
<a name="l00693"></a>00693             <span class="keywordflow">if</span> ([key isEqualToString:<span class="stringliteral">@&quot;image&quot;</span>]) {
<a name="l00694"></a>00694                 [queue addOperationWithBlock:^{
<a name="l00695"></a>00695                     NSString *url = [<span class="keyword">self</span> buildThumbUrlForEntity_:entity];
<a name="l00696"></a>00696                     if (url)
<a name="l00697"></a>00697                         [entity setObject:url forKey:@&quot;image&quot;];
<a name="l00698"></a>00698                     else
<a name="l00699"></a>00699                         [entity removeObjectForKey:@&quot;image&quot;];
<a name="l00700"></a>00700                 }];
<a name="l00701"></a>00701                 <span class="keywordflow">continue</span>;
<a name="l00702"></a>00702             }
<a name="l00703"></a>00703             
<a name="l00704"></a>00704             <span class="keywordflow">if</span> ([value isKindOfClass:[NSDictionary <span class="keyword">class</span>]] &amp;&amp;
<a name="l00705"></a>00705                 [[value objectForKey:<span class="stringliteral">@&quot;link_type&quot;</span>] isEqualToString:<span class="stringliteral">@&quot;local&quot;</span>]) {
<a name="l00706"></a>00706                 NSString *localPath = [value objectForKey:self.clientCaps.localPathField];
<a name="l00707"></a>00707                 <span class="keywordflow">if</span> (localPath != Nil) {
<a name="l00708"></a>00708                     [value setObject:localPath forKey:@&quot;local_path&quot;];
<a name="l00709"></a>00709                     [value setObject:[NSString stringWithFormat:@&quot;file://%@&quot;, localPath] forKey:@&quot;url&quot;];
<a name="l00710"></a>00710                 }
<a name="l00711"></a>00711             }
<a name="l00712"></a>00712         }
<a name="l00713"></a>00713     }
<a name="l00714"></a>00714     [queue waitUntilAllOperationsAreFinished];
<a name="l00715"></a>00715     <span class="keywordflow">return</span> ret;
<a name="l00716"></a>00716 }
<a name="l00717"></a>00717 
<a name="l00718"></a>00718 - (NSString *)buildThumbUrlForEntity_:(<a class="code" href="interface_shotgun_entity.html" title="Represents a Shotgun entity.">ShotgunEntity</a> *)entity
<a name="l00719"></a>00719 {
<a name="l00720"></a>00720     NSString *path = [[NSString
<a name="l00721"></a>00721                        stringWithFormat:@&quot;/upload/get_thumbnail_url?entity_type=%@&amp;entity_id=%@&quot;, 
<a name="l00722"></a>00722                        [entity <a class="code" href="interface_shotgun_entity.html#a729ad89492821607dbe65c36f88a7950" title="The type of the entity in Shotgun.">entityType</a>], [entity <a class="code" href="interface_shotgun_entity.html#ad0d9a488012066062fa6c4f7137ec21f" title="The id of the entity in Shotgun.">entityId</a>]]
<a name="l00723"></a>00723                       stringByAddingPercentEscapesUsingEncoding:NSASCIIStringEncoding];
<a name="l00724"></a>00724     <a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> *request = 
<a name="l00725"></a>00725         [<a class="code" href="interface_shotgun_request.html" title="Represents a simple request being made to a Shotgun instance.">ShotgunRequest</a> <a class="code" href="interface_shotgun_request.html#a3f57155d0223b7dbc2df085410418476">shotgunRequestWithConfig</a>:self.config <a class="code" href="interface_shotgun_request.html#a3f57155d0223b7dbc2df085410418476">path</a>:path <a class="code" href="interface_shotgun_request.html#a3f57155d0223b7dbc2df085410418476">body</a>:Nil <a class="code" href="interface_shotgun_request.html#a3f57155d0223b7dbc2df085410418476">headers</a>:Nil <a class="code" href="interface_shotgun_request.html#a3f57155d0223b7dbc2df085410418476">andHTTPMethod</a>:@&quot;GET&quot;];
<a name="l00726"></a>00726     [request <a class="code" href="interface_shotgun_request.html#ac522786022d1f48bb55502df523c2ee3">startSynchronous</a>];
<a name="l00727"></a>00727     NSString *body = [request <a class="code" href="interface_shotgun_request.html#a3dffc7ec86880fa40ac3890c2a92e0d6" title="The return value of the request.">response</a>];
<a name="l00728"></a>00728     NSArray *parts = [body componentsSeparatedByString:@&quot;\n&quot;];
<a name="l00729"></a>00729     NSInteger code = [(NSString *)[parts objectAtIndex:0] integerValue];
<a name="l00730"></a>00730     <span class="keywordflow">if</span> (code == 0)
<a name="l00731"></a>00731         SG_ERROR(<span class="stringliteral">@&quot;Error getting thumbnail url for entity %@ response was &#39;%@&#39;&quot;</span>, entity, body);
<a name="l00732"></a>00732     <span class="keywordflow">if</span> (code == 1) {
<a name="l00733"></a>00733         NSString *path = [parts objectAtIndex:1];
<a name="l00734"></a>00734         <span class="keywordflow">if</span> ([path length] == 0)
<a name="l00735"></a>00735             <span class="keywordflow">return</span> Nil;
<a name="l00736"></a>00736         NSURL *url = [[[NSURL alloc] initWithScheme:self.config.scheme host:self.config.server path:[parts objectAtIndex:1]] autorelease];
<a name="l00737"></a>00737         <span class="keywordflow">return</span> [url absoluteString];
<a name="l00738"></a>00738         
<a name="l00739"></a>00739     }
<a name="l00740"></a>00740     SG_ERROR(<span class="stringliteral">@&quot;Error getting thumbnail url: Unknown code %d %@&quot;</span>, code, parts);
<a name="l00741"></a>00741     <span class="keywordflow">return</span> Nil;
<a name="l00742"></a>00742 }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744 -(NSArray *)listFromObj_:(<span class="keywordtype">id</span>)obj
<a name="l00745"></a>00745 {
<a name="l00746"></a>00746     <span class="keywordflow">return</span> [<span class="keyword">self</span> listFromObj_:obj withKeyName:@&quot;field_name&quot; andValueName:@&quot;value&quot;];       
<a name="l00747"></a>00747 }
<a name="l00748"></a>00748 
<a name="l00749"></a>00749 - (NSArray *)listFromObj_:(<span class="keywordtype">id</span>)obj withKeyName:(NSString *)keyName andValueName:(NSString *)valueName 
<a name="l00750"></a>00750 {
<a name="l00751"></a>00751     NSMutableArray *ret = [NSMutableArray array];
<a name="l00752"></a>00752     <span class="keywordflow">if</span> (obj == Nil)
<a name="l00753"></a>00753         <span class="keywordflow">return</span> ret;
<a name="l00754"></a>00754     <span class="keywordtype">id</span> checkedObj = obj;
<a name="l00755"></a>00755     <span class="keywordflow">if</span> ([checkedObj isKindOfClass:[NSString <span class="keyword">class</span>]])
<a name="l00756"></a>00756         checkedObj = [(NSString *)obj JSONValue];
<a name="l00757"></a>00757     <span class="keywordflow">if</span> (![checkedObj isKindOfClass:[NSDictionary <span class="keyword">class</span>]])
<a name="l00758"></a>00758         [NSException raise:@&quot;Value Error&quot; format:@&quot;Cannot interpret argument as a dictionary: %@&quot;, obj];
<a name="l00759"></a>00759     <span class="keywordflow">for</span> (<span class="keywordtype">id</span> key in checkedObj)
<a name="l00760"></a>00760         [ret addObject:[NSDictionary dictionaryWithObjectsAndKeys:
<a name="l00761"></a>00761                             key, keyName,
<a name="l00762"></a>00762                             [checkedObj objectForKey:key], valueName,
<a name="l00763"></a>00763                         nil]];
<a name="l00764"></a>00764     <span class="keywordflow">return</span> ret;
<a name="l00765"></a>00765 }
<a name="l00766"></a>00766 
<a name="l00767"></a>00767 - (NSDictionary *)buildPayloadWithConfig_:(ShotgunConfig *)config Method:(NSString *)method andParams:(NSDictionary *)params includeScriptName:(BOOL)includeScriptName
<a name="l00768"></a>00768 {
<a name="l00769"></a>00769     NSMutableArray *callParams = [NSMutableArray array];
<a name="l00770"></a>00770     <span class="keywordflow">if</span> (includeScriptName) {
<a name="l00771"></a>00771         NSMutableDictionary *authParams = [NSMutableDictionary dictionaryWithObjectsAndKeys:
<a name="l00772"></a>00772                                             config.scriptName, @&quot;script_name&quot;,
<a name="l00773"></a>00773                                             config.apiKey, @&quot;script_key&quot;,
<a name="l00774"></a>00774                                             nil];
<a name="l00775"></a>00775         <span class="keywordflow">if</span> (config.sessionUuid)
<a name="l00776"></a>00776             [authParams setValue:config.sessionUuid forKey:@&quot;session_uuid&quot;];
<a name="l00777"></a>00777         [callParams addObject:authParams];
<a name="l00778"></a>00778     }
<a name="l00779"></a>00779     <span class="keywordflow">if</span> (params)
<a name="l00780"></a>00780         [callParams addObject:params];
<a name="l00781"></a>00781     NSDictionary *ret = [NSDictionary dictionaryWithObjectsAndKeys:
<a name="l00782"></a>00782              method, @&quot;method_name&quot;,
<a name="l00783"></a>00783              callParams, @&quot;params&quot;,
<a name="l00784"></a>00784              nil];
<a name="l00785"></a>00785     <span class="keywordflow">return</span> ret;
<a name="l00786"></a>00786 }
<a name="l00787"></a>00787 
<a name="l00788"></a>00788 - (id)transformOutboundData_:(<span class="keywordtype">id</span>)data
<a name="l00789"></a>00789 {
<a name="l00790"></a>00790     id(^outboundVisitor)(id) = ^(<span class="keywordtype">id</span> value) {
<a name="l00791"></a>00791         <span class="keywordflow">if</span> ([value isKindOfClass:[NSDate <span class="keyword">class</span>]]) {
<a name="l00792"></a>00792             NSString *ret = Nil;
<a name="l00793"></a>00793             <span class="keywordflow">if</span> ([value isKindOfClass:[<a class="code" href="interface_shotgun_date_time.html" title="A thin wrapper around NSDate to be able to differentiate date objects from datetime objects...">ShotgunDateTime</a> <span class="keyword">class</span>]]) {
<a name="l00794"></a>00794                 NSDateFormatter *formatter = [[[NSDateFormatter alloc] init] autorelease];
<a name="l00795"></a>00795                 [formatter setDateFormat:@&quot;yyyy-MM-dd&#39;T&#39;HH:mm:ss&#39;Z&#39;&quot;];
<a name="l00796"></a>00796                 ret = [formatter stringFromDate:value];
<a name="l00797"></a>00797             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ([value isKindOfClass:[<a class="code" href="interface_shotgun_date.html" title="A thin wrapper around NSDate to be able to differentiate date objects from datetime objects...">ShotgunDate</a> <span class="keyword">class</span>]]) {
<a name="l00798"></a>00798                 NSDateFormatter *formatter = [[[NSDateFormatter alloc] init] autorelease];
<a name="l00799"></a>00799                 [formatter setDateFormat:@&quot;yyyy-MM-dd&quot;];
<a name="l00800"></a>00800                 ret = [formatter stringFromDate:value];
<a name="l00801"></a>00801             } <span class="keywordflow">else</span> {
<a name="l00802"></a>00802                 [NSException raise:@&quot;Shotgun Error&quot; format:@&quot;Cannot pass in a NSDate, must be ShotgunDate or ShotgunDateTime&quot;];
<a name="l00803"></a>00803             }
<a name="l00804"></a>00804             <span class="keywordflow">return</span> ret ? ret : value;
<a name="l00805"></a>00805         }
<a name="l00806"></a>00806         <span class="keywordflow">return</span> value;
<a name="l00807"></a>00807     };
<a name="l00808"></a>00808     <span class="keywordtype">id</span> ret = [<span class="keyword">self</span> visitData_:data withVisitor:outboundVisitor];
<a name="l00809"></a>00809     <span class="keywordflow">return</span> ret;
<a name="l00810"></a>00810 }
<a name="l00811"></a>00811 
<a name="l00812"></a>00812 - (id)transformInboundData_:(<span class="keywordtype">id</span>)data
<a name="l00813"></a>00813 {
<a name="l00814"></a>00814     id(^inboundVisitor)(id) = ^(<span class="keywordtype">id</span> value) {
<a name="l00815"></a>00815         <span class="keywordflow">if</span> ([value isKindOfClass:[NSString <span class="keyword">class</span>]]) {
<a name="l00816"></a>00816             <span class="keywordflow">if</span>([value length] == 20) {
<a name="l00817"></a>00817                 NSDateFormatter *formatter = [[[NSDateFormatter alloc] init] autorelease];
<a name="l00818"></a>00818                 [formatter setDateFormat:@&quot;yyyy-MM-dd&#39;T&#39;HH:mm:ss&#39;Z&#39;&quot;];
<a name="l00819"></a>00819                 NSDate *convertedDate = [formatter dateFromString:value];
<a name="l00820"></a>00820                 <a class="code" href="interface_shotgun_date_time.html" title="A thin wrapper around NSDate to be able to differentiate date objects from datetime objects...">ShotgunDateTime</a> *date = [<a class="code" href="interface_shotgun_date_time.html" title="A thin wrapper around NSDate to be able to differentiate date objects from datetime objects...">ShotgunDateTime</a> <a class="code" href="interface_shotgun_date_time.html#af7bcf7991ab62301457f74155e71f134">dateTimeWithDate</a>:convertedDate];
<a name="l00821"></a>00821                 <span class="keywordflow">return</span> date ? date : value;
<a name="l00822"></a>00822             }
<a name="l00823"></a>00823         }
<a name="l00824"></a>00824         <span class="keywordflow">return</span> value;
<a name="l00825"></a>00825     };
<a name="l00826"></a>00826     <span class="keywordtype">id</span> ret = [<span class="keyword">self</span> visitData_:data withVisitor:inboundVisitor];
<a name="l00827"></a>00827     <span class="keywordflow">return</span> ret;
<a name="l00828"></a>00828 }
<a name="l00829"></a>00829 
<a name="l00830"></a>00830 - (id)visitData_:(<span class="keywordtype">id</span>)data withVisitor:(<span class="keywordtype">id</span> (^)(<span class="keywordtype">id</span>))visitor
<a name="l00831"></a>00831 {
<a name="l00832"></a>00832     <span class="keywordflow">if</span> (data == Nil)
<a name="l00833"></a>00833         <span class="keywordflow">return</span> Nil;
<a name="l00834"></a>00834     <span class="keywordflow">if</span> ([data isKindOfClass:[NSArray <span class="keyword">class</span>]]) {
<a name="l00835"></a>00835         NSMutableArray *ret = [NSMutableArray array];
<a name="l00836"></a>00836         <span class="keywordflow">for</span> (<span class="keywordtype">id</span> value in data)
<a name="l00837"></a>00837             [ret addObject:[<span class="keyword">self</span> visitData_:value withVisitor:visitor]];
<a name="l00838"></a>00838         <span class="keywordflow">return</span> ret;
<a name="l00839"></a>00839     }
<a name="l00840"></a>00840     <span class="keywordflow">if</span> ([data isKindOfClass:[NSDictionary <span class="keyword">class</span>]]) {
<a name="l00841"></a>00841         NSMutableDictionary *ret = [NSMutableDictionary dictionary];
<a name="l00842"></a>00842         <span class="keywordflow">for</span> (<span class="keywordtype">id</span> value in data)
<a name="l00843"></a>00843             [ret setObject:[<span class="keyword">self</span> visitData_:[data objectForKey:value] withVisitor:visitor]
<a name="l00844"></a>00844                     forKey:value];
<a name="l00845"></a>00845         <span class="keywordflow">return</span> ret;
<a name="l00846"></a>00846     }
<a name="l00847"></a>00847     <span class="keywordtype">id</span> ret = visitor(data);
<a name="l00848"></a>00848     <span class="keywordflow">return</span> ret;
<a name="l00849"></a>00849 }
<a name="l00850"></a>00850 
<a name="l00851"></a>00851 <span class="keyword">@end</span>
</pre></div></div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Properties</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Thu Jun 23 2011 18:09:46 for Shotgun ObjC Api by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
